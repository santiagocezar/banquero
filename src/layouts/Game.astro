---
interface Props {
    title: string;
}
---

<html lang="en">
    <head>
        <meta charset="utf-8" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        <title>{Astro.props.title}</title>
    </head>
    <body>
        <header>
            <p>
                jugando al {Astro.props.title}
            </p>
            <button id="share">Compartir</button>
        </header>
        <slot />
    </body>
</html>

<style lang="less">
    body {
        display: flex;
        overflow: hidden;
        flex-direction: column;
        height: 100%;
    }
    header {
        height: 4rem;
        flex-shrink: 0;
        border-bottom: 1px solid var(--p50);
    }
</style>

<script>
    import * as fflate from "fflate";
    /*
    yep, the browser API just sucks, not even the FileReader trick was 
    useful, as navigation.share cannot be called asynchronously
    */
    import * as base64 from "js-base64";

    const shareBtn = document.getElementById("share");
    if (shareBtn instanceof HTMLButtonElement) {
        shareBtn.addEventListener("click", async (btn) => {
            const url = new URL(location.href);
            const id = url.searchParams.get("id")!;
            const data = localStorage.getItem(id)!; // won't work the first 2 seconds
            const compressed = fflate.gzipSync(new TextEncoder().encode(data));
            const encoded = base64.fromUint8Array(compressed, true);
            url.searchParams.delete("id");
            url.searchParams.set("data", encoded);
            navigator.share({
                title: "Compartir partida",
                url: url.toString(),
            });
        });
    }
</script>
